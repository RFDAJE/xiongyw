https://coderamp.wordpress.com/2013/10/26/webrtc-what-is-ice/

WebRTC.. what is ICE?

Filed under: WebRTC — Leave a comment
October 26, 2013
Every time you hear of WebRTC  you hear of many acronyms like UDP, TCP, SDP.., most of these you understand but there are some you seem to have no clue of. One such acronym frequently quoted on blogs and technical documentation related to WebRTC is ICE. What is ICE after all? Is it behind the chilling effect WebRTC always has on people who try to learn it? I may say ‘yes’ to an extent, but I feel compelled to explain this further before I commit myself to the subzero temperatures of WebRTC.

So what is ICE? The easiest answer to this question is that “ICE is a clever technique to find a path of communication between peers despite NAT,( or in spite it?)”.

Well you see, when your browser wishes to establish a direct and unhindered communication channel to the peer for streaming audio and video, it faces a lot of routing on the network. This routing may range from minimal in case of peers on the same LAN to horrendous in case peers are oceans away from each other. Each peer may be behind a router, hence may not have a direct port and IP exposed to the peer for connection, rather it may have a port mapped to its IP and port pair on the router. Now this is not always simple, this routing may take myriad forms such as symmetric, non symmetric etc, these are out of scope for this article.

for the sake of simplicity and objectivity let’s assume there are two peers Paul and Pushpa who want to connect to each other, each is behind a NAT. To provide each other the network address where they can connect with each other for streaming they needs to find out potential ‘candidates’ for connection.

To learn it’s own IP and port as it appears outside the NAT, to Pushpa, Paul may ask a STUN server, which is sitting on the internet.

Paul – “Hey Stun, I am behind a NAT, I don’t know my own public access IP and port. Can you check and let me know how do I look from outside on the internet?” .

The STUN server checks and says

"sure, to me you are 14.34.143.1 34044"

Paul is now happy as it knows its own IP and port on the internet as that is where Pushpa is.

Paul thinks – “This can be one way Pushpa may connect to and communicate with me; so I should keep it in a safe place like a session description”

So an ICE candidate is added to the Session Description by Paul.

Similarly Paul may have access to a TURN server, now TURN is a kind of relay server that can act as an intermediary between Paul and Pushpa, it can receive the stream of Paul and transparently pass it on to Pushpa. This both Paul and Pushpa may communicate, even though they could not maintain a peer to peer connection. Thus Paul adds the TURN server too to its list of candidates, just to be safe in case nothing else works.

Finally, Paul thinks, “What if Pushpa is on the same LAN as I am, maybe there is no NAT to traverse.. Pushpa will be able to connect to me directly on my local address and port”. So Paul adds his local address and port as an ICE candidate to his Session Description.

Now Paul’s session description as generated by the browser contains quite a number of things including the media capabilities, the codecs and the ICE candidates collected by Paul and added to the Session Description. Paul now sends this session description over the signalling channel to Pushpa. This signalling channel could be anything on the basic level. It’s a real-time communication medium that instantaneously provides the data sent to the other party. We will discuss possible communication/ signalling channel in a later post.

Now Pushpa too has been waiting impatiently at the other end for long and now receives the message Paul had sent enthusiastically. She eagerly scrapes the message for details, especially the session description, she reads the media capabilities of Paul, the codecs supported by him and finally the ICE candidates supplied. If she agrees with the media capabilities proposed by Paul and finds that she will be able to support the same, she starts preparing her own Session Description and starts collecting her own ICE candidates, this is the same process that Paul did earlier.
After collection she starts pairing up her own gathered candidates with the candidates sent by Paul and starts trying connection from her candidate to Paul’s candidate in each pair. Now ICE candidates broadly are nothing but an IP and port, she immediately starts trying to connect using each pair, now it’s important to note here that what I have described here is an oversimplification of the process, actually the process involves a lot of techniques and procedures for just choosing the order in which the ICE candidates need to be tried. The following link is a nice presentation that explains the techniques in more details.

http://www.jdrosen.net/papers/ice-basic-tutorial.pdf

Before Pushpa can finalize on a pair on which the connection works, she should have sent her session description with ICE candidates to Paul. Paul at his end would also pair up the candidates and  try to connect on each pair.

The end result will be that both Pushpa and Paul will have a set of pairs that work, either of them can now pick one and start the much desired peer to peer communication.

Thus, you see ICE is a technique critical to the establishment of a peer to peer connection. It’s a clever way of figuring out possible routes between two parties which are not necessarily present on the same network and hidden behind complicated NATs.